<dom-module id="haushaltsbuch-overview">
  <style>
    #cards {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
      @apply(--layout-wrap);
      margin-left: auto;
      margin-right: auto;
    }

    .categoryCard {
      margin: 5px;
      width: 102px;
      height: 130px;
    }

    .categoryCard .title {
      position: absolute;
      top: 30px;
      left: 100px;
      color: var(--paper-indigo-500);
    }

    .categoryCard img {
      width: 100%;
    }

    .categoryCard .big {
      font-size: 22px;
      padding: 8px 0 16px;
      color: var(--google-grey-500);
    }

    .categoryCard .medium {
      font-size: 16px;
      padding-bottom: 8px;
    }

    .avatar {
      display: inline-block;
      height: 64px;
      width: 64px;
      border-radius: 50%;
      background: var(--paper-pink-500);
      color: white;
      line-height: 64px;
      font-size: 30px;
      text-align: center;
    }

    .total {
        font-size: large;
        margin-top: 5px;
    }

    #total {
      font-size: x-large;
    }

    #totalCard {
      width: 100%;
      height: 130px;
    }

    h1 {
      text-align: center;
      font-weight: 400;
    }

    #cardsContainer {
      width: 85%;
      margin: 5% auto;
      text-align: center;
    }


  </style>
  <template>
    <iron-localstorage
      id="localstorage"
      name="expenses"
      value="{{expenses}}"
    ></iron-localstorage>

    <div id="cardsContainer">

      <h1>Übersicht</h1>

      <paper-card  id = "totalCard">
        <div class="card-content">
          <haushaltsbuch-select-category-button icon="shopping-basket" name="Gesamt" no-margin></haushaltsbuch-select-category-button>
          <div id="total">{{_formatPrice(ausgabenGesamt)}}<span>€</span></div>
        </div>
      </paper-card>

      <div id="cards">
        <template is="dom-repeat" items="[[cards]]" as="item">
          <paper-card  class="categoryCard">
            <div class="card-content">
              <haushaltsbuch-select-category-button icon="[[item.icon]]" name="[[item.name]]" no-margin></haushaltsbuch-select-category-button>
              <div class="total">{{_formatPrice(item.total)}}<span>€</span></div>
            </div>
          </paper-card>
        </template>
      </div>

      <paper-button id="reload" on-tap="reload">Aktualisieren</paper-button>
    </div>
  </template>

<script>
(function() {
  Polymer({
    is: 'haushaltsbuch-overview',

    properties: {
      ausgabenGesamt: {
        type: Number,
        value: 0.0
      },

      expenses: {
        type: Array,
        observer: '_expensesChanged'
      },

      cards: {
        type: Array
      }
    },

    ready : function() {
    },

    attached : function() {
    },

    _expensesChanged: function() {
      this.cards = [];
      this.ausgabenGesamt = 0;
      var categories = new Map();
      var that = this;

      if (this.expenses && this.expenses.length > 0) {
        this.expenses.forEach(function(elem, i) {
          elem.expenses.forEach(function(exp, j) {
            if (!categories.hasOwnProperty(exp.product.category.name)) {
              categories[exp.product.category.name] = {};
              categories[exp.product.category.name].total = 0.0;
              categories[exp.product.category.name].icon = exp.product.category.icon;
            }
            categories[exp.product.category.name].total += parseInt(exp.total);
            that.ausgabenGesamt += parseInt(exp.total);
          });
        });

        for (var cat in categories) {
          if (categories.hasOwnProperty(cat)) {
            var expCat = {};
            expCat.name = cat;
            expCat.total = categories[cat].total;
            expCat.icon = categories[cat].icon;
            this.push('cards', expCat);
          }
        }
      }
    },

    _formatPrice : function(price) {
      return parseFloat(price / 100).toFixed(2);
    },

    reload : function() {
      this.$.localstorage.reload();
    }
  });
})();
</script>

</dom-module>
